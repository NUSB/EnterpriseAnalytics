<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User</title>
    <style>
        body {
            margin:0;
            padding:0;
        }
    </style>
</head>
<body>
<canvas style="border: 1px solid black" id="graphicFrame"></canvas>

<script>


    function GraphicFrame() {
        var canvas = document.getElementById("graphicFrame");
        canvas.width = window.innerWidth-8;
        canvas.height = window.innerHeight-8;
        var context = canvas.getContext("2d");
        var bias = new Point(0, 0);
        var chartModel = new ChartModel();
        var activeChartObject = null;

        var oldPosition = null;
        var workWithObject = null;
        canvas.addEventListener("mousemove", function (event) {
            if (workWithObject === null) {
                activeChartObject = chartModel.findChartObjectByPoint(new Point(event.pageX + bias.x, event.pageY + bias.y));
            }
            if (oldPosition !== null) {
                var dX = oldPosition.x - event.pageX;
                var dY = oldPosition.y - event.pageY;

                if (workWithObject !== null) {
                    chartModel.moveCharObject(workWithObject, new Point(-dX, -dY));
                } else {
                    bias.x += dX;
                    bias.y += dY;
                }
                oldPosition = new Point(event.pageX, event.pageY);
            }


            graphicFrame.draw();
        });
        canvas.addEventListener("mousedown", function (event) {
            oldPosition = new Point(event.pageX, event.pageY);
            if (activeChartObject !== null) {
                workWithObject = activeChartObject;
            }
        });
        canvas.addEventListener("mouseup", function (event) {
            workWithObject = null;
            oldPosition = null;
        });



        this.draw = function () {
            context.fillStyle = "#3e3e3e";
            context.fillRect(0, 0, canvas.width, canvas.height);

            var chartObjects = chartModel.getAllChartObjects();
            for (let i = 0; i < chartObjects.length; i++) {
                chartObjects[i].draw(context, bias, TypeViewChartObject.PASSIVE);
            }

            context.fillStyle = "rgba(0, 0, 0, 0.6)";
            context.fillRect(0, 0, canvas.width, canvas.height);

//            todo: Код по отображению линий
            if (activeChartObject !== null) {
                activeChartObject.draw(context, bias, TypeViewChartObject.ACTIVE);
            }
        };

    }

    function Point(x, y) {
        this.x = x;
        this.y = y;
    }

    var TypeViewChartObject={
        PASSIVE:0,
        ACTIVE:1
    };


    function ChartObject(position, name, type, info, link) {
        this.position = position;
        this.name = name;
        this.type = type;
        this.info = info;
        this.link = link;
        this.rendererMap = new Map();
        this.rendererMap.set("default", new DefaultRenderer(this));

        this.containsPoint = function (point) {
            console.error("Method containtsPoint isn't overridden");
            return false;
        };

        this.draw = function (context, bias, typeRendering) {
            if (this.rendererMap.get(typeRendering) === undefined) {
                typeRendering = "default";
            }
            this.rendererMap.get(typeRendering).draw(context, bias);
        };

        this.move = function (point) {
            this.position.x += point.x;
            this.position.y += point.y;
        };
    }


    function Role(position, name, type, info, link) {
        ChartObject.call(this,position, name, type, info, link);
        this.width = 30;
        this.height = 90;
        this.rendererMap.set(TypeViewChartObject.PASSIVE, new RolePassiveRenderer(this));
        this.rendererMap.set(TypeViewChartObject.ACTIVE, new RoleActiveRenderer(this));

        this.containsPoint = function(point) {
            return point.x > position.x && point.x < position.x+this.width
                && point.y > position.y && point.y < position.y+this.height;
        };
    }


    function Document(position, name, type, info, link) {
        ChartObject.call(this,position, name, type, info, link);
        this.width = 180;
        this.height = 40;
        this.rendererMap.set(TypeViewChartObject.PASSIVE, new DocumentPassiveRenderer(this));
        this.rendererMap.set(TypeViewChartObject.ACTIVE, new DocumentActiveRenderer(this));

        this.containsPoint = function(point) {
            return point.x > position.x && point.x < position.x+this.width
                && point.y > position.y && point.y < position.y+this.height;
        };
    }


    function Account(position, name, type, info, link) {
        ChartObject.call(this,position, name, type, info, link);
        this.radius = 25;
        this.rendererMap.set(TypeViewChartObject.PASSIVE, new AccountPassiveRenderer(this));
        this.rendererMap.set(TypeViewChartObject.ACTIVE, new AccountActiveRenderer(this));

        this.containsPoint = function(point) {
            return (Math.pow(point.x-position.x, 2) + Math.pow(point.y-position.y, 2)) < this.radius*this.radius;
        };
    }


    function Correspondence(position, name, type, info, link) {
        ChartObject.call(this,position, name, type, info, link);
        this.width = 30;
        this.height = 20;
        this.rendererMap.set(TypeViewChartObject.PASSIVE, new CorrespondencePassiveRenderer(this));
        this.rendererMap.set(TypeViewChartObject.ACTIVE, new CorrespondenceActiveRenderer(this));

        this.containsPoint = function (point) {
            return point.x > position.x && point.x < position.x+this.width
                && point.y > position.y && point.y < position.y+this.height;
        };
        this.move = function (point) {};




    }

    function Renderer(chartObject) {
        this.draw = function (context, bias) {
            console.error("Method isn't instantiated");
        };
    }

    function DefaultRenderer(chartObject) {
        Renderer.call(this, chartObject);
        var width = 180;
        var height = 40;
        this.fillColor = "#3e3e3e";
        this.color = "#ff000f";
        var fontSize = 14;

        this.draw = function(context, bias) {
            console.log("Default");
            context.fillStyle = this.fillColor;
            context.beginPath();

            context.fillRect(chartObject.position.x-bias.x, chartObject.position.y-bias.y, width, height);
            context.strokeStyle = this.color;
            context.strokeRect(chartObject.position.x-bias.x, chartObject.position.y-bias.y, width, height);
            context.closePath();
            context.fillStyle = this.color;
            context.font = fontSize + "px Arial";
            var text = "default renderer: " + chartObject.name;
            context.fillText(text, chartObject.position.x-bias.x + (width - context.measureText(text).width)/2, chartObject.position.y-bias.y+height/2+fontSize/3);
            context.stroke();
        }
    }

    function DocumentPassiveRenderer(chartObject) {
        Renderer.call(this, chartObject);
        this.fillColor = "#3e3e3e";
        this.color = "#ffffff";
        var fontSize = 14;

        this.draw = function(context, bias) {
            context.fillStyle = this.fillColor;
            context.beginPath();
            context.fillRect(chartObject.position.x-bias.x, chartObject.position.y-bias.y, chartObject.width, chartObject.height);
            context.strokeStyle = this.color;
            context.strokeRect(chartObject.position.x-bias.x, chartObject.position.y-bias.y, chartObject.width, chartObject.height);
            context.fillStyle = this.color;
            context.closePath();
            context.font = fontSize + "px Arial";
            context.fillText(chartObject.name, chartObject.position.x-bias.x + (chartObject.width - context.measureText(chartObject.name).width)/2, chartObject.position.y-bias.y+chartObject.height/2+fontSize/3);
            context.stroke();
        }
    }

    function DocumentActiveRenderer(chartObject) {
        DocumentPassiveRenderer.call(this, chartObject);
        this.color = "#99ffb9";
    }


    function AccountPassiveRenderer(chartObject) {
        Renderer.call(this, chartObject);
        this.fillColor = "#3e3e3e";
        this.color = "#FFFFFF";
        var fontSize = 14;


        this.draw = function(context, bias) {
            context.beginPath();
            context.arc(chartObject.position.x-bias.x, chartObject.position.y-bias.y, chartObject.radius, 0, 2 * Math.PI, false);
            context.fillStyle = this.fillColor;
            context.fill();
            context.strokeStyle = this.color;
            context.stroke();
            context.fillStyle = this.color;
            context.closePath();
            context.font = fontSize + "px Arial";
            context.fillText(chartObject.name, chartObject.position.x-bias.x + (chartObject.radius - context.measureText(chartObject.name).width)/2 - chartObject.radius/2, chartObject.position.y-bias.y+fontSize/2);
            context.stroke();
        }
    }

    function AccountActiveRenderer(chartObject) {
        AccountPassiveRenderer.call(this, chartObject);
        this.color = "#ffb9d4";
    }

    function RolePassiveRenderer(chartObject) {
        Renderer.call(this, chartObject);
        this.color = "#FFFFFF";
        var fontSize = 14;

        this.draw = function (context, bias) {
            context.strokeStyle = this.color;
            console.log("RolePassive");
            context.beginPath();
            context.arc(chartObject.position.x-bias.x+chartObject.width/2, chartObject.position.y-bias.y+chartObject.width/2, chartObject.width/2, 0, 2*Math.PI);
            context.moveTo(chartObject.position.x-bias.x+chartObject.width/2, chartObject.position.y-bias.y+chartObject.height/3);
            context.lineTo(chartObject.position.x-bias.x+chartObject.width/2, chartObject.position.y-bias.y+(7*chartObject.height)/9);
            context.lineTo(chartObject.position.x-bias.x, chartObject.position.y-bias.y+chartObject.height);
            context.moveTo(chartObject.position.x-bias.x+chartObject.width/2, chartObject.position.y-bias.y+(7*chartObject.height)/9);
            context.lineTo(chartObject.position.x-bias.x+chartObject.width, chartObject.position.y-bias.y+chartObject.height);
            context.moveTo(chartObject.position.x-bias.x, chartObject.position.y-bias.y+(4*chartObject.height)/9);
            context.lineTo(chartObject.position.x-bias.x+chartObject.width, chartObject.position.y-bias.y+(4*chartObject.height)/9);
            context.closePath();
            context.stroke();

            context.fillStyle = this.color;
            context.font = fontSize + "px Arial";
            context.fillText(chartObject.name, chartObject.position.x-bias.x + (chartObject.width - context.measureText(chartObject.name).width)/2, chartObject.position.y+chartObject.height-bias.y+fontSize);
            context.stroke();
        }
    }

    function RoleActiveRenderer(chartObject) {
        RolePassiveRenderer.call(this, chartObject);

        this.color = "#12ff4e";
    }

    function CorrespondencePassiveRenderer(chartObject){
        Renderer.call(this, chartObject);
        this.fillColor = "#3e3e3e";
        this.color = "#FFFFFF";

        this.draw = function(context, bias) {
            context.beginPath();
            context.moveTo(chartObject.position.x-bias.x+chartObject.width/2, chartObject.position.y-bias.y);
            context.lineTo(chartObject.position.x-bias.x+chartObject.width, chartObject.position.y-bias.y+chartObject.height);
            context.lineTo(chartObject.position.x-bias.x, chartObject.position.y-bias.y+chartObject.height);
            context.closePath();

            context.strokeStyle = this.color;
            context.stroke();

            context.fillStyle = this.fillColor;
            context.fill();

        }
    }

    function CorrespondenceActiveRenderer(chartObject) {
        CorrespondencePassiveRenderer.call(this, chartObject);
        this.fillColor = "#cc6428";

    }



    function ChartModel() {
        var chartObjects = [new Document(new Point(400, 100), "Поступление на счет", "doc", "doc_1", "doc/1")
            , new Document(new Point(350, 200), "Приходная накладная", "doc", "doc_2", "doc/2")
            , new Role(new Point(200, 100), "Кассир", "role", "role_1", "role/1")
            , new Role(new Point(50, 200), "Кладовщик", "role", "role_2", "role/2")
            , new Account(new Point(500, 500), "30", "acc", "Касса", "account/1")
            , new Account(new Point(500, 700), "40", "acc", "Рассчеты с поставщиками", "account/2")
            , new Correspondence(new Point(480, 600), "", "crr", "Дт 40:Кт 30", "correspondence/2")
        ];

        this.getAllChartObjects = function () {
            return chartObjects;
        };

        this.findChartObjectByPoint = function(point) {
            for (let i = 0; i < chartObjects.length; i++) {
                if (chartObjects[i].containsPoint(point) === true){
                    return chartObjects[i];
                }
            }

            return null;
        };

        this.moveCharObject = function (charObject, point) {
            charObject.move(point);
        };

    }
    
    graphicFrame = new GraphicFrame();
    graphicFrame.draw();
</script>
</body>
</html>